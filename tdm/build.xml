<?xml version="1.0"?>
<project name="tdm" default="thredds" basedir=".">
  <echo>basedir=${basedir}</echo>
  <tstamp>
    <format property="build.time" pattern="yyyy-MM-dd HH:mm:ss" timezone="GMT"/>
    <format property="build.time.number" pattern="yyyyMMdd.HHmm" timezone="GMT"/>
  </tstamp>

  <property name="release.version" value="4.3"/>
  <!-- TeamCity sets "build.number" property to value of its build counter. -->
  <property name="build.number" value="${build.time.number}" />
  <property name="release.version.minor" value="${release.version}.${build.number}"/>

  <property name="build.debug" value="on"/>
  <property name="build.release" value="false"/>

  <!-- Load environment and user properties. -->
  <property environment="env"/>
  <property file="${user.home}/build.properties"/>

  <property name="root.dir" location="${basedir}"/>
  <property name="src.dir" location="${root.dir}/src/main/java"/>
  <property name="resources.dir" location="${root.dir}/src/main/resources"/>
  <property name="lib.dir" location="${root.dir}/../lib"/>

  <property name="build.dir" value="${root.dir}/target"/>
  <property name="build.classes.dir" value="${build.dir}/classes"/>
  <property name="javadoc.dir" value="${build.dir}/javadoc"/>
  <property name="javadocAll.dir" value="${build.dir}/javadocAll"/>

  <property name="cdm.jar" value="netcdfAll-4.3.jar"/>
  <property name="spring-aop.jar" value="org.springframework.aop-3.0.5.RELEASE.jar"/>
  <property name="spring-asm.jar" value="org.springframework.asm-3.0.5.RELEASE.jar"/>
  <property name="spring-beans.jar" value="org.springframework.beans-3.0.5.RELEASE.jar"/>
  <property name="spring-context.jar" value="org.springframework.context-3.0.5.RELEASE.jar"/>
  <property name="spring-core.jar" value="org.springframework.core-3.0.5.RELEASE.jar"/>
  <property name="spring-expression.jar" value="org.springframework.expression-3.0.5.RELEASE.jar"/>
  <property name="slf4jImpl.jar" value="slf4j-log4j12-1.6.1.jar"/>
  <property name="log4j.jar" value="log4j-1.2.16.jar"/>
  <property name="commons-logging.jar" value="jcl-over-slf4j-1.6.1.jar"/>

  <!-- source -->
  <path id="sourcepath">
    <pathelement location="${src.dir}"/>
  </path>

  <!-- Libraries -->
  <path id="compile.classpath">
    <fileset id="compile.libraries" dir="${lib.dir}">
      <include name="release/${cdm.jar}"/>
      <include name="external/${log4j.jar}"/>
      <include name="external/${spring-beans.jar}"/>
      <include name="external/${spring-context.jar}"/>
      <include name="external/${spring-core.jar}"/>
    </fileset>
  </path>

  <!-- targets -->
  <target name="init">
    <mkdir dir="${build.classes.dir}"/>
    <echo message="Initialize ${ant.project.name}"/>
  </target>

  <target name="clean" description="Deletes all files that are generated by the build.">
    <delete dir="${build.dir}" failonerror="false"/>
  </target>

  <target name="release-settings">
    <condition property="build.debuglevel" value="lines">
      <istrue value="${build.release}"/>
    </condition>
    <property name="build.debuglevel" value="lines,vars,source"/>
    <!-- echo>release.build=${release.build}</echo>
       <echo>build.debuglevel=${build.debuglevel}</echo -->
  </target>

  <!-- $$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$  -->
  <!-- core library -->

  <target name="compile" depends="release-settings" description="library compile">
    <delete dir="${build.classes.dir}" failonerror="false"/>
    <mkdir dir="${build.classes.dir}"/>

    <javac destdir="${build.classes.dir}" debug="${build.debug}" debuglevel="${build.debuglevel}" includeAntRuntime="false">
      <src refid="sourcepath"/>
      <classpath refid="compile.classpath"/>
    </javac>
  </target>

  <!-- make all-in-one jar -->
  <property name="jarName" value="tdm-${release.version}.jar"/>
  <property name="zip.dir" value="${build.dir}/zip"/>
  <target name="makeJar" depends="compile" description="make core library jar">
    <delete dir="${zip.dir}" failonerror="false"/>
    <mkdir dir="${zip.dir}"/>

    <unzip dest="${zip.dir}">
      <fileset dir="${lib.dir}">
        <include name="release/${cdm.jar}"/>
        <include name="external/${spring-aop.jar}"/>
        <include name="external/${spring-asm.jar}"/>
        <include name="external/${spring-beans.jar}"/>
        <include name="external/${spring-context.jar}"/>
        <include name="external/${spring-core.jar}"/>
        <include name="external/${spring-expression.jar}"/>
      </fileset>
    </unzip>

    <!--remove slf4j-jdk14 whch is in netcdfAll.jar -->
    <delete dir="${zip.dir}/org/slf4j/impl" failonerror="true"/>

    <!--add slf4j-log4j -->
    <unzip dest="${zip.dir}">
      <fileset dir="${lib.dir}">
        <include name="external/${slf4jImpl.jar}"/>
        <include name="external/${log4j.jar}"/>
        <include name="external/${commons-logging.jar}"/>
      </fileset>
    </unzip>

    <jar jarfile="${build.dir}/${jarName}" index="true">
      <fileset dir="${zip.dir}"/>
      <fileset dir="${build.classes.dir}"/>
      <fileset dir="${build.dir}" includes="README"/>
      <fileset dir="${build.dir}" includes="CHANGES"/>

      <fileset dir="${resources.dir}">
        <include name="log4j.xml"/>
        <include name="resources/**"/>
      </fileset>

      <manifest>
        <attribute name="Main-Class" value="thredds.tdm.TdmRunner"/>
        <!-- attribute name="Class-Path" value="${ClassPath}"/ -->
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Built-On" value="${build.time}"/>
        <attribute name="Implementation-Title" value="Thredds Data Manager"/>
        <attribute name="Implementation-Version" value="${release.version.minor}"/>
        <attribute name="Implementation-Vendor" value="UCAR/Unidata"/>
      </manifest>

    </jar>
  </target>

  <target name="thredds" depends="clean, makeJar" description="make and release thredds jar">
      <copy file="${build.dir}/${jarName}" todir="../lib/release/" />
  </target>

</project>
