<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>CdmrFeature Grammar</title>
  <link href="../../cdm.css" rel="stylesheet" type="text/css"/>

</head>

<body>
<h1>CdmrFeature Grammer (DRAFT)</h1>
<p>Generally follows or reuses the <a href="NcstreamGrammer.html">NcStream grammer</a> whenever possible.</p>

<h2>Grammer </h2>

<p>An <em><strong>cdmrfstream</strong></em> is an ordered sequence of one or more messages:</p>
<pre><em><strong>   </strong></em><strong>cdmrfstream</strong>= <strong>MAGIC_START</strong>, <strong></strong>{message}*, <strong>MAGIC_END</strong>
   <strong>message</strong> = headerMessage | dataMessage | errorMessage
   <strong>headerMessage</strong> = MAGIC_HEADER, vlenb, CdmrFeatureProto.GridCoverageDataset
   <strong>dataMessage</strong> = MAGIC_DATA, vlenb, CdmrFeatureProto.DataResponse, <strong>arrayDataList</strong> <strong></strong>
   <strong>errorMessage</strong> = MAGIC_ERR, vlenb, NcStreamProto.Error<strong>

   arrayDataList</strong>= vlenn, {<strong>arrayData</strong>}*vlenn
   <strong>arrayData</strong> = vlenb, (byte)*vlenb

   <strong>vlenb</strong> = variable length encoded positive integer == length of the following object in bytes
   <strong>vlenn</strong> = variable length encoded positive integer == number of objects that follow
   <strong>byte</strong> = actual bytes of data, encoding described by the NcStreamProto.Data message

primitives (same as ncstream):

   <strong>MAGIC_START</strong> = 0x43, 0x44, 0x46, 0x53
   <strong>MAGIC_HEADER</strong>= 0xad, 0xec, 0xce, 0xda
   <strong>MAGIC_DATA</strong> =  0xab, 0xec, 0xce, 0xba
   <strong>MAGIC_VDATA</strong> = 0xab, 0xef, 0xfe, 0xba
   <strong>MAGIC_VEND </strong> = 0xed, 0xef, 0xfe, 0xda
   <strong>MAGIC_ERR</strong>   = 0xab, 0xad, 0xba, 0xda
   <strong>MAGIC_END</strong> =   0xed, 0xed, 0xde, 0xde</pre>
<p>The protobuf messages are defined by </p>
<ul>
  <li><strong>{repo}/cdm/src/main/java/ucar/nc2/stream/ncStream.proto</strong></li>
  <li><strong>{repo}/cdm/src/main/java/    ucar/nc2/ft2/coverage/remote/cdmrfeature.proto<br/>
  </strong></li>
</ul>
<p>These are compiled by the protobuf compiler into Java. Python, and C code that does the actual encoding/decoding
  from the on-the-wire stream. </p>
<h2><strong>Header Message</strong></h2>
<p>&nbsp;</p>

<h2><strong>Data Response Message</strong></h2>
<p>The DataResponse has a list of GeoReferencedArray objects, which may share the same coordinate system. Following the Data Response Message are the actual data arrays, in the same order as the GeoReferencedArrays (see <strong>arrayDataList</strong> above in grammer)</p>
<pre>message&#32;DataResponse&#32;{<br />&#32;&#32;repeated&#32;CoordAxis&#32;coordAxes&#32;=&#32;1;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;may&#32;be&#32;shared&#32;if&#32;asking&#32;for&#32;multiple&#32;grids<br />&#32;&#32;repeated&#32;CoordSys&#32;coordSys&#32;=&#32;2;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;&#32;&#32;&#32;&quot;<br />&#32;&#32;repeated&#32;CoordTransform&#32;coordTransforms&#32;=&#32;3;&#32;&#32;&#32;//&#32;&#32;&#32;&#32;&quot;<br /><br />&#32;&#32;repeated&#32;GeoReferencedArray&#32;geoArray&#32;=&#32;4;<br />}
</pre>
<ol>
  <li><em>List&lt;CoordAxis&gt; coordAxes</em> used in one or more of the returned GeoReferencedArray.</li>
  <li><em>List&lt;CoordSys&gt; coordSys</em> used in one or more of the returned GeoReferencedArray.</li>
  <li><em>List&lt;CoordTransform&gt; coordTransforms </em> used in one or more of the returned GeoReferencedArray.</li>
  <li><em>List&lt;GeoReferencedArray&gt;geoArray</em> are the results of the query.</li>
</ol>
<h3>GeoReferencedArray</h3>
Follows <a href="NcstreamGrammer.html#DataMessage">NcStream
Data Message</a> as much as possible.
<pre>
enum&#32;Compress&#32;{<br />&#32;&#32;NONE&#32;=&#32;0;<br />&#32;&#32;DEFLATE&#32;=&#32;1;<br />}
message&#32;GeoReferencedArray&#32;{<br />&#32;&#32;required&#32;string&#32;coverageName&#32;=&#32;1;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;full&#32;escaped&#32;name.<br />&#32;&#32;required&#32;DataType&#32;dataType&#32;=&#32;2;<br />&#32;&#32;optional&#32;bool&#32;bigend&#32;=&#32;3&#32;[default&#32;=&#32;true];<br />&#32;&#32;optional&#32;uint32&#32;version&#32;=&#32;4&#32;[default&#32;=&#32;0];<br />&#32;&#32;optional&#32;Compress&#32;compress&#32;=&#32;5&#32;[default&#32;=&#32;NONE];<br />&#32;&#32;optional&#32;uint64&#32;uncompressedSize&#32;=&#32;6;<br /><br />&#32;&#32;repeated&#32;uint32&#32;shape&#32;=&#32;7;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;the&#32;shape&#32;of&#32;the&#32;returned&#32;array<br />&#32;&#32;repeated&#32;string&#32;axisName&#32;=&#32;8;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;//&#32;each&#32;dimension&#32;corresponds&#32;to&#32;this&#32;axis<br />&#32;&#32;required&#32;string&#32;coordSysName&#32;=&#32;9;&#32;&#32;&#32;&#32;&#32;//&#32;must&#32;have&#32;coordAxes&#32;corresponding&#32;to&#32;shape<br />}</pre>
<ol>
  
  <li>full name of Coverage</li>
  <li><em>ucar.nc2.DataType</em> for the returned array: <strong>byte, short, int, long</strong> (signed) or <strong>ubyte, ushort, uint, ulong</strong> (unsigned), or <strong>float</strong>, <strong>double</strong>.</li>
  <li>stored in big or small endian (reader makes right).</li>
  <li>version of the data storage format (not currently needed).</li>
  <li>compression algorithm.</li>
  <li>uncompressed size of the returned data, in bytes.</li>
  <li>int[] shape of returned array</li>
  <li>String[] axisName, corresponding to shape.</li>
  <li>Reference to coordSys in the <em>DataResponse</em> message.</li>
</ol>
<h3><strong>Data Array</strong></h3>
<ol>
  <li>After decompression (if needed) the number of bytes of the data array is <em>uncompressedSize</em>.</li>
  <li>The number of elements of the array is <em>uncompressedSize</em> / sizeof (<em>dataType</em>).</li>
  <li>The number of elements must match the <em>int[] shape</em> array.</li>
  <li>The data elements are laid out sequentially in row-major order (first dimension varies slowest).</li>
  <li>The <em>int[] shape</em> array describes how to interpret the data as a multidimensional array.</li>
  <li>For each dimension in the <em>shape</em> array, there is a corresponding <em>axisName</em>, which refers to a <em>coordAxis</em> in the Data Response message.</li>
  <li>The size of the <em>coordAxis</em> must match the corrresponding <em>shape</em> length. </li>
  <li>The values of the <em>coordAxis</em> are coordinate values for the returned data array.</li>
</ol>
<hr width="100%"/>
<address>
  <img src="../../nc.gif" alt="" width="64" height="64"/> This document  was last
  updated July 2015
</address>
<p>&nbsp;</p>
</body>
</html>
