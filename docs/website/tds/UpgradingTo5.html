<!DOCTYPE html PUBLIC "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>Upgrading To TDS 4.5</title>
  <link rel="stylesheet" href="tds.css" type="text/css">
</head>
<body>
<h1><img alt="Unidata" src="images/unidataLogo.png" align="middle" height="75" width="75"> Upgrading To TDS version 5</h1>

<hr>
<h2>Requirements</h2>
<ul>
  <li>Java 8 is now required</li>
  <li>Tomcat 8 (servlet 3.1)</li>
  <li>On the command line when starting up Tomcat, you must specify <strong>-Dtds.content.root.path=&lt;content root&gt;</strong> where &lt;content root&gt; points to the top of the content directory. Note that this is<strong> ${tomcat}/content/</strong>, not<strong> ${tomcat}/content/thredds/</strong>. Dont forget the trailing slash. For example: 
    <pre>-Dtds.content.root.path=/opt/tomcat-home/content/</pre>
  </li>
</ul>
<h2>Overview</h2>
<p>The configuration catalogs and internal state of the TDS has been extensively reworked to be able to scale to large numbers of catalogs, datasets, and internal objects without excessive use of memory. A running TDS can be triggered to reread the configuration catalogs without having to restart. It can be configured to  reread only changed catalogs, for fast incremental updates. Other features have been added to make writing configuration catalogs more maintainable, including the <em>catalogScan</em> element, and default and standard services.</p>
<p>The other major enhancement is that <em>GridDataset</em> is being replaced by <em>GridCoverage</em>, to better support very large feature collections. The GridCoverage API works only with coordinate values, which solves various intractable problems  that arise when using aray index subsetting on large collections.</p>
<p>Deprecated classes and methods have been removed, and the module structure and third-party jar use has been improved.</p>
<p>&nbsp;</p>
<h2>API Changes</h2>
<h3>Catalogs</h3>
<ul>
  <li>All uses of classes in <strong>thredds.catalog.*</strong> are deprecated. If you still need, you must add <strong>legacy.jar</strong> to your path.</li>
  <li>TDS and CDM now use<strong> thredds.server.catalog.*</strong> and <strong>thredds.client.catalog.*</strong></li>
</ul>
<h3>Viewers</h3>
<ul>
  <li><strong>thredds.servlet.Viewer </strong>has<strong> InvDatasetImpl </strong>changed to<strong> Dataset</strong></li>
  <li><strong>thredds.servlet.ViewerLinkProvider </strong>has<strong> InvDatasetImpl </strong>changed to<strong> Dataset</strong></li>
  <li><strong>thredds.server.viewer.dataservice.ViewerService </strong>has<strong> InvDatasetImpl </strong>changed to<strong> Dataset</strong></li>
</ul>
<h3>Coordinate Systems</h3>
<ul>
  <li>    <strong>ucar.nc2.dataset.CoordTransBuilderIF </strong>is split into     <strong>ucar.nc2.dataset.builder.HorizTransformBuilderIF</strong> and <strong>ucar.nc2.dataset.builder.VertTransformBuilderIF</strong></li>
  <li><strong>HorizTransformBuilderIF </strong>now uses <strong>AttributeContainer</strong>
    instead of <strong>NetcdfDataset, Variable</strong>
    <ul>
      <li><em>CoordinateTransform&#32;makeCoordinateTransform(NetcdfDataset&#32;ds,&#32;Variable&#32;ctv)</em> is now <em>ProjectionCT
        ma</em><em>keCoordinateTransform(AttributeContainer&#32;ctv)
      </em></li>
    </ul>
  </li>
  <li>Previously, the optional <strong>false_easting</strong><em><strong><a name="false_easting"></a>, </strong></em>and<em><strong> false_northing</strong></em> should match the units
  of the x and y projection coordinates</li>
</ul>
<h3>Feature Types</h3>
<ul>
  <li> <strong>ucar.nc2.dt.TypedDatasetFactory </strong>has been removed. Use <strong>ucar.nc2.ft.FeatureDatasetFactoryManager.</strong></li>
</ul>
<h3>Unsigned Types</h3>
<ul>
  <li><strong>DataType</strong> now has unsigned types: UBYTE, USHORT, UINT, ULONG</li>
  <li>Array,    ArrayScalar,  ArrayByte, ArrayInt, ArrayShort, ArrayLong factory and constructor methods now require isUnsigned parameter. </li>
  <li>Array.factory(class, shape) -&gt; Array.factory(DataType, shape) or Array.factory(dataType, class, shape)</li>
  <li>Array.get1DJavaArray(Class) -&gt; Array.get1DJavaArray(DataType) or Array.get1DJavaArray(Class, isUnsigned)</li>
  <li>remove Array.setUnsigned(), Variable.setUnsigned() </li>
  <li>Variable.getUnsigned() -&gt; Variable.getDataType().getUnsigned() </li>
  <li>    Attribute(String&#32;name,&#32;List&#32;values) -&gt; Attribute(String&#32;name,&#32;List&#32;values,&#32;boolean&#32;isUnsigned) </li>
  <li>StructureDataScalar.addMember(    String&#32;name,&#32;String&#32;desc,&#32;String&#32;units,&#32;DataType&#32;dtype,&#32;boolean isUnsigned, Number&#32;val  ) -&gt; StructureDataScalar.addMember(    String&#32;name,&#32;String&#32;desc,&#32;String&#32;units,&#32;DataType&#32;dtype,&#32;Number&#32;val  ) -&gt; </li>
</ul>
<h3>Miscellaneous</h3>
<ul>
  <li><strong>DiskCache2</strong>: 
    <ul>
      <li>now has one cleanup thread for all instances of <em>DiskCache</em>. </li>
      <li>The <em>DiskCache2.exit()</em> method is now static and needs only be called once.</li>
      <li><em>DiskCache2.setLogger()</em> is removed.</li>
      <li>logging of routine cache cleanup is at the debug level</li>
      <li><em>DiskCache2.cleanCache(File&#32;dir,&#32;StringBuffer&#32;sbuff,&#32;boolean&#32;isRoot)</em> is now    <em>DiskCache2.cleanCache(File&#32;dir,&#32;Formatter&#32;sbuff,&#32;boolean&#32;isRoot)</em>;</li>
      <li>deprecated methods removed:        <em>setCachePathPolicy(int&#32;cachePathPolicy,&#32;String&#32;cachePathPolicyParam) ,        setPolicy(int&#32;cachePathPolicy)      </em></li>
    </ul>
  </li>
</ul>
<h2>Catalog Schema changes</h2>
<p>Schema version is now 1.2.</p>
<h3>Client Catalogs</h3>
<ul>
  <li><strong>service</strong> elements may not be nested inside of <strong>dataset</strong> elements, they must be directly contained in the <strong>catalog</strong> element.</li>
</ul>
<h3>Server Configuration Catalogs</h3>
<ul>
  <li>the <strong>catalogScan</strong> element is now available, which scans a directory for catalog files (any file ending in xml)</li>
  <li>the <strong>datasetFmrc</strong> element is no longer supported</li>
  <li><strong>datasetRoot</strong> elements may not be contained inside of <strong>service</strong> elements, they must be directly contained in the <strong>catalog</strong> element</li>
  <li><strong>service</strong> elements may not be nested inside of <strong>dataset</strong> elements, they must be directly contained in the <strong>catalog</strong> element.</li>
  <li><strong>service</strong> elements no longer need to be explicitly defined in each config catalog, but may reference user defined global services</li>
  <li>if the <strong>datatype/featureType</strong> is defined for a dataset, then the <strong>service</strong> element may be ommited, and the default set of services for that <strong>datatype</strong> will be used.</li>
</ul>
<h3>DatasetScan</h3>
<ul>
  <li><strong>addID</strong> is no longer needed, ids are always added</li>
  <li><strong>addDatasetSize </strong> is no longer needed, the dataset size is always added</li>
  <li>With <strong>addLatest</strong>, the <strong>service</strong> name is no longer used, it is always <em>Resolver</em>, and the correct service is automatically added. Use <strong>addLatest</strong> attribute for simple case.</li>
  <li><strong>fileSort: </strong>by default, datasets at each collection level are listed
  in increasing order by filename. To change to decreasing order, use the <em><a href="reference/DatasetScan.html#filesSort">filesSort</a></em> element.</li>
  <li><strong>sort: </strong>deprecated in favor of <strong>filesSort</strong></li>
  <li><strong>User pluggable classes implementing UserImplType</strong> (crawlableDatasetImpl, crawlableDatasetFilterImpl, crawlableDatasetLabelerImpl, crawlableDatasetSorterImpl) are no longer supported. (This was never officially released or documented).</li>
  <li>DatasetScan details are <a href="catalog/InvCatalogServerSpec.html">here</a></li>
</ul>
<h3>Standard Services</h3>
<ul>
  <li>The TDS provides standard service elements, which know which services are appropriate for each Feature Type.</li>
  <li>User defined services in the root catalog are global and can be referenced by name in any other config catalog. </li>
  <li>User defined services  in non-root catalogs are local to that catalog and override (by name) any global services.</li>
  <li>All services are enabled unless explicitly disabled
    <ul>
      <li>Except for remote catalog services</li>
    </ul>
  </li>
  <li>Standard service  details are <a href="reference/Services.html">here</a></li>
</ul>
<h3>FeatureCollections</h3>
<ul>
  <li>The  <strong><a href="reference/collections/FeatureCollections.html#update">update</a></strong> element default is now <em>startup=&quot;never&quot;</em>, meaning do not update collection on startup, and use existing indices when the collection is accessed.</li>
  <li>The <strong><a href="reference/collections/FeatureCollections.html#filesSort">fileSort</a></strong> element is now inside the <strong>featureCollection</strong> itself, so it can be processed uniformly for all types of feature collections. When a collection shows a list of files, the files will be sorted by increasing name. To use a decreasing sort, use the element <strong>&lt;filesSort increasing=&quot;false&quot; /&gt;</strong> inside the <strong>featureCollection</strong> element. This supercedes the old way of placing that element in the <strong>&lt;gribConfig&gt;</strong> element, or the older verbose  <strong>lexigraphicByName</strong> element:
    <pre>  &lt;filesSort&gt;
    &lt;lexigraphicByName increasing="false" /&gt;  // deprecated
  &lt;/filesSort&gt;</pre>
  </li>
  <li>Feature Collection details are <a href="reference/collections/FeatureCollections.html">here</a> </li>
</ul>
<h3>Recommendations for 5.0 catalogs</h3>
<ul>
  <li>Put all <strong>datasetRoot</strong> elements in root catalog.</li>
  <li>Put all <strong>catalogScan</strong> elements in root catalog.</li>
  <li>Use StandardServices when possible. Annotate your datasets with <strong>featureType</strong> / <strong>dataType</strong>.</li>
  <li>Put all user-defined <strong>service</strong> elements in root catalog.</li>
  <li>Only use  user-defined <strong>service</strong> elements in non-root catalogs when they are experimental or truly a special case.</li>
</ul>
<h2>ThreddsConfig.xml</h2>
<ul>
  <li>You no longer turn catalog caching on or off, but you  can control how many catalogs are cached (see <a href="reference/ThreddsConfigXMLFile.html#CatalogCaching">here</a> for the new syntax).So the following is no longer used:
    <pre>
&lt;Catalog&gt;
  &lt;cache&gt;false&lt;/cache&gt;
&lt;/Catalog&gt;
</pre></li>
</ul>
<h2>Reccomendations for ESGF<a name="ESGF"></a></h2>
<ol>
  <li>You must determine the number of datasets that are contained in all of your catalogs. To  get a report, enable <a href="reference/RemoteManagement.html">Remote Management</a>, and from <strong>https://server/thredds/admin/debug</strong>, select <em>&quot;Make Catalog Report&quot;</em>. This may take 5-20 minutes, depending on the numbers of catalogs.</li>
  <li>Add the <a href="reference/ThreddsConfigXMLFile.html#CatalogCaching">ConfigCatalog</a> element to threddsConfig.xml:</li>
<blockquote>
<pre>
&lt;ConfigCatalog&gt;
  &lt;keepInMemory&gt;100&lt;/keepInMemory&gt;
  &lt;reread&gt;check&lt;/reread&gt;
  &lt;dir&gt;/tomcat_home/content/thredds/cache/catalog/&lt;/dir&gt;
  &lt;maxDatasets&gt;1000000&lt;/maxDatasets&gt;
&lt;/ConfigCatalog&gt;
</pre>
  <p>where:</p>
  <ul>
    <li><strong>keepInMemory:</strong> using the default value of 100 is probably good enough. </li>
    <li><strong>reread: </strong>use value of <em>check</em> to only read changed catalogs when restarting TDS.</li>
    <li><strong>dir</strong> is where the catalog cache files are kept. Use the default directory (or symlink to another place) unless you have a good reason to change.</li>
    <li><strong>maxDatasets</strong>: this is the number you found in step 1. Typical values for ESGF are 1 - 7 million. This is a maximum, so its ok to make it bigger than you need. </li>
    </ul>
</blockquote>
  <li>Here are some additional, optional changes you can make to increase maintainability:
    <ol>
      <li>Place all <strong>datasetRoot</strong> elements in the top catalog</li>
      <li>Place all <strong>service</strong> elements in the root catalog (<em>catalog.xml</em>). These can be referencced from any catalog. </li>
      <li>Remove <strong>service</strong> selements from non-root catalogs.</li>
      <li>Add a <strong><a href="catalog/InvCatalogServerSpec.html#catalogScan">catalogScan</a></strong> element to the root catalog, replacing the  list of catalogRefs listing all the other catalogs.
        <ul>
          <li>This assumes that other catalogs live in a subdirectory under the root, for example<strong> ${tds.content.root.path}/thredds/esgcet/</strong>.</li>
        </ul>
      </li>
    </ol>
  </li>
</ol>
For example:
<pre>&lt;?xml version='1.0' encoding='UTF-8'?&gt;
&lt;catalog name=&quot;ESGF Master Catalog&quot; version=&quot;1.2&quot;
		xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot;
      xmlns=&quot;http://www.unidata.ucar.edu/namespaces/thredds/InvCatalog/v1.0&quot;
      xsi:schemaLocation=&quot;http://www.unidata.ucar.edu/namespaces/thredds/InvCatalog/v1.0 http://www.unidata.ucar.edu/schemas/thredds/InvCatalog.1.2.xsd&quot;&gt;
      
 &lt;datasetRoot location=&quot;/esg/data&quot; path=&quot;esg_testroot&quot;/&gt; 
 &lt;datasetRoot location=&quot;/esg/arc/data/&quot; path=&quot;esg_obs4MIPs&quot;/&gt;
 &lt;datasetRoot location=&quot;/esg/cordex/data/&quot; path=&quot;esg_cordex&quot;/&gt;
 &lt;datasetRoot location=&quot;/esg/specs/data/&quot; path=&quot;esg_specs&quot;/&gt;

 &lt;service base=&quot;/thredds/dodsC/&quot; desc=&quot;OpenDAP&quot; name=&quot;gridded&quot; serviceType=&quot;OpenDAP&quot;&gt;
  &lt;property name=&quot;requires_authorization&quot; value=&quot;false&quot;/&gt;
  &lt;property name=&quot;application&quot; value=&quot;Web Browser&quot;/&gt;
 &lt;/service&gt;

 &lt;service base=&quot;&quot; name=&quot;fileservice&quot; serviceType=&quot;Compound&quot;&gt;
  &lt;service base=&quot;/thredds/fileServer/&quot; desc=&quot;HTTPServer&quot; name=&quot;HTTPServer&quot; serviceType=&quot;HTTPServer&quot;&gt;
    &lt;property name=&quot;requires_authorization&quot; value=&quot;true&quot;/&gt;
    &lt;property name=&quot;application&quot; value=&quot;Web Browser&quot;/&gt;
    &lt;property name=&quot;application&quot; value=&quot;Web Script&quot;/&gt;
  &lt;/service&gt;
  &lt;service base=&quot;gsiftp://cmip-bdm1.badc.rl.ac.uk/&quot; desc=&quot;GridFTP&quot; name=&quot;GridFTPServer&quot; serviceType=&quot;GridFTP&quot;&gt;
    &lt;property name=&quot;requires_authorization&quot; value=&quot;true&quot;/&gt; 
    &lt;property name=&quot;application&quot; value=&quot;DataMover-Lite&quot;/&gt;
  &lt;/service&gt;
  &lt;service base=&quot;/thredds/dodsC/&quot; desc=&quot;OpenDAP&quot; name=&quot;OpenDAPFiles&quot; serviceType=&quot;OpenDAP&quot;&gt;
    &lt;property name=&quot;requires_authorization&quot; value=&quot;false&quot;/&gt;
    &lt;property name=&quot;application&quot; value=&quot;Web Browser&quot;/&gt;
  &lt;/service&gt;
 &lt;/service&gt;

 &lt;catalogScan name=&quot;ESGF catalogs&quot; path=&quot;esgcet&quot; location=&quot;esgcet&quot; /&gt;

&lt;/catalog&gt;</pre>
<p>&nbsp;</p>
<hr>

<address>
  <img src="thread.png" alt="TDS" height="108" width="110">This document is maintained by Unidata and was
  last updated June 30, 2015. Send comments to <a href="mailto:support-thredds@unidata.ucar.edu">THREDDS
  support</a>.
</address>

</body>
</html>
