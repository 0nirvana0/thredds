<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Untitled Document</title>
</head>
<body>
<h2>Spring DI</h2>
<ul>
  <li>dont do any heavy processing in the bean initialization phase, just get the beans wired in</li>
  <li>http://stackoverflow.com/questions/6684451/executing-a-java-class-at-application-startup-using-spring-mvc
    <ul>
      <li><a href="http://static.springsource.org/spring/docs/3.0.x/javadoc-api/org/springframework/context/ApplicationListener.html">ApplicationListener</a>&lt;<a href="http://static.springsource.org/spring/docs/3.0.0.M3/javadoc-api/org/springframework/context/event/ContextRefreshedEvent.html">ContextRefreshedEvent</a>&gt;</li>
      <li>        &lt;bean id=&quot;eventListenerBean&quot; class=&quot;test.pack.age.ApplicationListenerBean&quot; /&gt;      </li>
    </ul>
  </li>
</ul>
<h3>Beans</h3>
<ul>
  <li>    TdsContext
    <ul>
      <li>calls        ThreddsConfig.init(), creates TdsConfigMapper      </li>
    </ul>
  </li>
  <li>DataRootManager
    <ul>
    <li>*TdsContext</li>
    <li>DataRootPathMatcher</li>
    <li>ConfigCatalogManager</li>
    <li>ConfigCatalogCache    </li>
    
    <li>FeatureCollectionCache</li>
    </ul>
  </li>
  <li>DatasetManager
    <ul>
      <li>DataRootManager</li>
      <li>FeatureCollectionCache</li>
    </ul>
  </li>
  <li>ConfigCatalogManager
    <ul>
      <li>TdsContext</li>
      <li>DataRootPathMatcher</li>
      <li>DatasetManager</li>
      <li>ConfigCatalogCache</li>
    </ul>
  </li>
  <li>CdmInit      
    <ul>
      <li>TdsContext</li>
      <li>DatasetManager</li>
    </ul>
  </li>
  <li>ConfigCatalogCache
    <ul>
      <li>TdsContext</li>
    </ul>
  </li>
</ul>
<h3>Startup</h3>
<ol>
  <li>    Tomcat loads <em>thredds.war</em> with /WEB-INF/web.xml</li>
  <li>org.springframework.web.context.<em>ContextLoaderListener</em> listens for context loading</li>
  <li>beans in <em>applicationContext.xml</em> are created and wired</li>
  <li>    ContextRefreshedEvent caught by TdsInit</li>
</ol>
<h3>threddsConfig.xml
</h3>
<ul>
  <li>CdmInit using ThreddsConfig</li>
  <li>ThreddsConfig.init() called from TdsContext.afterPropertiesSet()</li>
  <li>TdsConfigMapper seems to be ethan's replacement ??</li>
  <li>none of it using autowire</li>
</ul>
<p><br>
</p>
<h2>Spring MVC</h2>
<p>http://docs.spring.io/spring/docs/current/spring-framework-reference/html/mvc.html</p>
<p>Lots of ways, we want to standardize on one idiom.</p>
<h3>Handle completely</h3>
<ul>
  <li>see CdmRemoteController</li>
  <li>return  ResponseEntity&lt;String&gt;</li>
  <li>errors: handle these in the controller</li>
</ul>
<h3>ModelView</h3>
<ul>
  <li>use a view technology</li>
  <li>return a ModelView</li>
  <li>errors: throw exception, grab in an exception handler; essentially a way to switch return types</li>
  <li>see LocalCatalogServiceController</li>
</ul>
<h3>Validation</h3>
<ul>
  <li>@Valid JSP 303, with hibernate implementation</li>
  <li>org.springframework.validation.Validator</li>
  <li>must put initBinder() into Controller  </li>
  <li>see RemoteCatalogServiceController</li>
  <li>dont need DataBinder  </li>
</ul>
<h4>Error handling</h4>
<ul>
  <li>All errors are handled by throwing an excception which is picked up by an ExceptionHandler</li>
  <li> essentially a way to switch return types</li>
  <li>see https://spring.io/blog/2013/11/01/exception-handling-in-spring-mvc</li>
</ul>
<h2>&nbsp;</h2>
<h2>Servlets and Controllers mappings summary</h2>
<h2><a name="TDSServletsConfiguration%284.4.0-alpha%29-4.1Servlets" id="TDSServletsConfiguration%284.4.0-alpha%29-4.1Servlets"></a>4.1 Servlets</h2>
<div>
  <table border="2">
    <tbody>
      <tr>
        <th width="143">Servlet</th>
        <th width="182">Mapping</th>
      </tr>
      <tr>
        <td>Opendap</td>
        <td>/dodsC/*</td>
      </tr>
      <tr>
        <td>RestrictedDataset</td>
        <td>/restrictedAccess/*</td>
      </tr>
    </tbody>
  </table>
</div>
<h2><a name="TDSServletsConfiguration%284.4.0-alpha%29-4.2NonannotatedSpringcontrollers" id="TDSServletsConfiguration%284.4.0-alpha%29-4.2NonannotatedSpringcontrollers"></a>4.2 Non-annotated Spring controllers</h2>
<div>
  <table width="822" border="2">
    <tbody>
      <tr>
        <th width="237">Controller Class</th>
        <th width="102">Servlet Name</th>
        <th width="263">Mappings</th>
        <th width="190">Configuration file</th>
      </tr>
      <tr>
        <td>RadarCatalogController</td>
        <td>radarServer</td>
        <td>/radarServer/**/catalog.xml <br />
          /radarServer/**/dataset.xml <br />
          /radarServer/**/catalog.html <br />
          /radarServer/**/dataset.html</td>
        <td>radarServer-servlet.xml</td>
      </tr>
      <tr>
        <td>RadarQueryController</td>
        <td>radarServer</td>
        <td>/radarServer/*<strong>/</strong>?*</td>
        <td>radarServer-servlet.xml</td>
      </tr>
      <tr>
        <td>RadarStationController</td>
        <td>radarServer</td>
        <td>/radarServer/**/stations.xml</td>
        <td>radarServer-servlet.xml</td>
      </tr>
      <tr>
        <td>ThreddsWmsController</td>
        <td>wms</td>
        <td>/wms/**</td>
        <td>wms-servlet.xml</td>
      </tr>
      <tr>
        <td> </td>
        <td>root</td>
        <td>/</td>
        <td>servlet-context.xml</td>
      </tr>
    </tbody>
  </table>
</div>
<h2><a name="TDSServletsConfiguration%284.4.0-alpha%29-4.3AnnotatedSpringcontrollers" id="TDSServletsConfiguration%284.4.0-alpha%29-4.3AnnotatedSpringcontrollers"></a>4.3 Annotated Spring controllers</h2>
<div>
  <table border="2">
    <tbody>
      <tr>
        <th width="226">Controller Class</th>
        <th width="152">Handler method</th>
        <th width="479">Mapping</th>
      </tr>
      <tr>
        <td>RootController</td>
        <td>getRootPage</td>
        <td>/</td>
      </tr>
       <tr>
        <td>CollectionController</td>
        <td>handleCollectionTriggers</td>
        <td>/admin/collection <br />
          /admin/collection/trigger</td>
       </tr>
       <tr>
        <td>CollectionController</td>
        <td>showFmrcCache</td>
        <td>/admin/fmrcCache <br />
          /admin/fmrcCache/*</td>
      </tr>
        <tr>
        <td>DebugController</td>
        <td>showDebugPage</td>
        <td>/admin/debug <br />
          /admin/debug/*</td>
      </tr>
      <tr>
        <td>LogController</td>
        <td>handleRequestInternal</td>
        <td>/admin/log/** <br />
          /admin/roots</td>
      </tr>
      <tr>
        <td>DirDisplayController</td>
        <td>handleRequestInternal</td>
        <td>/admin/**</td>
      </tr>
      <tr>
        <td>LocalCatalogServiceController</td>
        <td>handleXmlRrequest<br />
        handleHtmlRrequest</td>
        <td>*.xml <br />
          *.html</td>
      </tr>
      <tr>
        <td>RemoteCatalogServiceController</td>
        <td>handleAll</td>
        <td>          /remoteCatalogService <br />
          /remoteCatalogValidation.html</td>
      </tr>
      <tr>
        <td>CdmrController</td>
        <td>handleRequest</td>
        <td>/cdmremote/**</td>
      </tr>
      <tr>
        <td>CdmrfController</td>
        <td>metadataRequestHandler</td>
        <td>/cdmrfeature/**, params={&quot;req!=data&quot;, &quot;req!=dataForm&quot;,&quot;req!=header&quot; }</td>
      </tr>
      <tr>
        <td>CdmrfController</td>
        <td>headerRequestHandler</td>
        <td>/cdmrfeature/**, params={&quot;req=header&quot;}</td>
      </tr>
      <tr>
        <td>CdmrfController</td>
        <td>dataRequestHandler</td>
        <td>/cdmrfeature/**, params={&quot;req=data&quot;}</td>
      </tr> 
      <tr>
        <td>FileServerController</td>
          <td>doGet</td>
      <td>/fileServer/**</td>
      </tr>
      <tr>
        <td>DLwriterController</td>
         <td>doGet</td>
       <td>/DLwriter/**</td>
      </tr>   
      <tr>
        <td>MetadataController</td>
        <td>getMetadata</td>
        <td>/metadata/**</td>
      </tr>
      <tr>
        <td>NcssController</td>
        <td>handleRequest <br /></td>
        <td>/ncss/**</td>
      </tr>
      <tr>
        <td>NcssDatasetInfoController</td>
        <td>getDatasetDescription</td>
        <td>/ncss/**/dataset.html <br />
          /ncss/**/dataset.xml </td>
      </tr>
      <tr>
        <td>NcssDatasetInfoController</td>
        <td>getStations</td>
        <td>/ncss/**/station.xml</td>
      </tr>
      <tr>
        <td>NcssDatasetBoundariesController</td>
        <td>getDatasetBoundaries</td>
        <td>/ncss/**/datasetBoundaries.xml</td>
      </tr>
      <tr>
        <td>ServerInfoController</td>
        <td>getServerInfoHtml<br/>
        getServerInfoXML<br/>
        getServerVersion</td>
        <td>/serverInfo.html<br/>
        /serverInfo.xml<br/>
        /serverVersion.txt
        </td>
      </tr>
     <tr>
        <td>ViewerController</td>
        <td>launchViewer</td>
        <td>{viewer}.jnlp</td>
      </tr>
      <tr>
        <td>WCSController</td>
        <td>doGet</td>
        <td>/wcs/*</td>
      </tr>
   </tbody>
  </table>
</div>
<h3>Debugging  </h3>
<p>1) Look in serverStartup.log and search for messages with &quot;RequestMappingHandlerMapping: Mapped&quot; :</p>
<pre>712013-10-23T13:54:40.342-0600 [     17458][        ] INFO  org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping: Mapped &quot;{[/admin/collection || /admin/collection/trigger],methods=[],params=[],headers=[],consumes=[],produces=[],custom=[]}&quot; onto protected org.springframework.web.servlet.ModelAndView thredds.server.admin.CollectionController.handleCollectionTriggers(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse) throws java.lang.Exception 
</pre>
<p><br>
2) set these to debug level:</p>
<pre> 
&lt;logger name=&quot;org.springframework.http&quot; level=&quot;info&quot; additivity=&quot;false&quot;&gt;
  &lt;appender-ref ref=&quot;threddsServlet&quot;/&gt;
&lt;/logger&gt;
&lt;logger name=&quot;org.springframework.web&quot; level=&quot;info&quot; additivity=&quot;false&quot;&gt;
  &lt;appender-ref ref=&quot;threddsServlet&quot;/&gt;
&lt;/logger&gt;</pre>
</body>
</html>
