<html>
<head>
<title>Session</title>
</head>
<body>
<center>
<h1>Session Control<br>
for netCDF Opendap</h1>
<h2>Dennis Heimbigner<br>
UCAR/Unidata</h2>
<h3>Draft 1: July 20, 2011</h3>
</center>

<h2><a name="HTTPSession"><u>HTTPSession and Session Semantics</u></a></h2>
New public classes are introduced to the package ucar.nc2.util.net.
These are
<i>HTTPSession.java</i>,
<i>HTTPMethod.java</i>,
<i>HTTPMethodStream.java</i>,
<i>HTTPException.java</i>,
These classes are intended to wrap various Apache httpclient-3 library
classes so that (1) it will simplify use,
and (2) it will be possible to later switch to, say,
the Apache httpclient4 library.
<p>
These classes support a form of <i>session</i>
semantics for Java network access. The notion of session
is only loosely tied to the HTTP notion of session.
<p>
A session is encapsulated in an instance of the class <i>HTTPSession</i>.
The encapsulation is with respect to a specific uri and (optionally) principal.
This means that once a session is specified, it is tied permanently
to that url and principal.
Note that the term "principal" is another name for user id.
If no principal is ever set, the the session assumes a special principal called
<i>ANY_PRINCIPAL</i>.
<p>
Currently principals are ignored, but will become important
when new authorization mechanisms are put in place.
Also, per-instance setting of principals is disabled because
the Apache httpclient-3 library cannot utilize them.
They will be activated when the httpclient-4 library replaces
the httpclient-3 library.

<p>
It is important to note that Session objects do NOT
correspond with the HttpClient objects of the Apache
httpclient library. A Session encapulates an instance of
an Apache HttpClient, but Sessions also wrap and control
httpclient library methods such as GetMethod via the class
<i><a href="#HTTPMethod">HTTPMethod</a></i>. This is so
it can ensure that the Session - url correspondence
is not violated
(see <a href="#HTTPMethodURL">here</a> for additional details).

<h3><a name="HTTPMethod">HTTPMethod</a></h3>
This class encapsulates the information
about a given method request and response.
Its primary operation is <i>execute()</i>,
which causes a request to be sent to a server
and a response obtained.
<p>
The <i>HTTPMethod</i> operates as a factory for
creating <i>HTTPMethod</i> instances.
To create a method for doing an HTTP GET operation,
for example, one would invoke this operation
<pre>
HTTPMethod m = HTTPMethod.Get(session);
</pre>
where "session" is a previously created session object.

<h3><a name="HTTPMethodStream">HTTPMethodStream</a></h3>
The purpose of this class is to allow
other classes to access the data stream
associated with a method response.
It tracks the method and the session
to allow them to be closed
when the stream hits eof.

<h3><a name="HTTPException">HTTPException</a></h3>
This class is a subclass of <i>java.io.IOException</i>.
It is the exception for reporting errors out of the
classes listed above.

<h3><u>Examples</u></h3>

<h4>Example 1: Create/Use/Release Cycle</h4>

<pre>
public class Main
{
    public static void main(String[] argv)
    {
	String url = argv[0];
        HTTPSession session = new HTTPSession(url);
        HTTPMethod method = HTTPMethod.Get(session);
        int status = method.execute();
        System.out.printf("Execute: status code = %d\n", status);
	method.close();
	session.close();
    }
}
</pre>

<h4>Example 2: Quick Request/Response Cycle</h4>
<pre>
public class Main
{
    public static void main(String[] argv)
    {
	String url = argv[0[];
	// The class HttpClientManager has a number of static
        // methods that wrap HTTPSession and HTTPMethod.
	// Specifyin null as the first argument forces HttpClientManager
        // to create and destroy an internal HTTPSession instance.
	string content = HttpClientManager.getUrlContentsAsString(null,url,1024);
    }
}
</pre>

<h4>Example 3: Setting Some Global Parameters</h4>

<pre>
public class Main
{
    public static void main(String[] argv)
    {
	String url = argv[0];

        HTTPSession.setGlobalPrincipal(System.getProperty("user.name"));
	HTTPSession.setGlobalUserAgent("netcdf/java");
	HTTPSession.setMaxConnections(4);
	HTTPSession.setGlobalAuthenticationPreemptive(true);

        HTTPSession session = new HTTPSession(url);
        HTTPMethod method = HTTPMethod.Get(session);
        int status = method.execute();
        System.out.printf("Execute: status code = %d\n", status);
	method.close();
	session.close();
    }
}
</pre>

<h4>Example 4: Setting Some Local Parameters</h4>
<pre>
public class Main
{
    public static void main(String[] argv)
    {
	String url = argv[0];

        HTTPSession session = new HTTPSession(url);
        session.setPrincipal(System.getProperty("user.name"));
	session.setAuthenticationPreemptive(true);
	session.setUserAgent("agent");
	session.setConnectionManagerTimeout(475);
	session.setSoTimeout(475);
	session.setProxy(); // Uses sytem properties "http.proxyHost"
                            // and  "http.proxyPort".

        HTTPMethod method = HTTPMethod.Get(session);
        int status = method.execute();
        System.out.printf("Execute: status code = %d\n", status);
	method.close();
	session.close();
    }
}
</pre>

<h3><a name="HTTPMethodURL"><u>Specifying a url when creating an HTTPMethod Instance</u></a></h3>
It is possible to specify a  url when invoking, for example,
<i>HTTPMethod.Get</i>.
This is because the url argument to the <i>HTTPSession</i> constructor actually serves two purposes.
First, if the method is created without specifying a url, then the session
url is used to specify the data to be retrieved by the method invocation.
<p>
Second, if the method is created and specifies a url, for example,
<pre>
HTTPMethod m = HTTPMethod.Get(session,url2);
</pre>
this second url is used to specify the data to be retrieved by the method invocation.
<p>
This might occur if, for example, the url given to <i>HTTPSession</i>
represented some general url such as
<i>http://motherlode.ucar.edu/path/file.nc</i>
and the url given to <i>HTTPMethod.Get</i> was for something more specific
such as <i>http://motherlode.ucar.edu/path/file.nc.dds</i>.
<p>
The important point is that this second url must be "compatible" with the session url.
The term "compatible" basically means that
the <i>HTTPSession</i> url, as a string, must be a prefix
of the url given to <i>HTTPMethod.Get</i>.
This maintains the semantics of the Session but allows flexibility in accessing
data from the server.

<h2><a name="Appendices"><u>Appendices: Session APIs</u></a></h2>
Note: the following set may lag the actual API, so the JavaDoc or code
should be referenced to see any modifications.

<h3><a name"HTTPSession.API">HTTPSession API</a></h3>
<h4>Static Get/Set Methods</h4>
<ul>
<li>public static synchronized void setGlobalPrincipal(String p)
     <ul>
     <li> Set a principal that will be used when establishing
          any session.
     </ul>
<li>public static synchronized String getGlobalPrincipal()
<li>public static synchronized void setGlobalUserAgent(String _userAgent)
     <ul>
     <li> Set a user agent that will be used when establishing
          any session.
     </ul>
<li>public static String getGlobalUserAgent()
<li>public static void setGlobalThreadCount(int nthreads)
     <ul>
     <li> Set the max number of threads that will be supported.
     </ul>
<li>public static int getGlobalThreadCount()
<li>static public void setGlobalCredentialsProvider(CredentialsProvider)
     <ul>
     <li> Backward compatibility; will create a row
          in <i>HTTPAuthStore</i> and an instance of
          <i>HTTPCreds</i> supporting global authorization
          using the specified credentials provider.
     <li> throws HTTPException
     </ul>
<li>public static Cookie[] getGlobalCookies()
     <ul>
     <li> Returns the set of cookies available on a generic session.
     </ul>
<li>public void setGlobalAuthenticationPreemptive(boolean tf)
     <ul>
     <li> Specifies that all HTTPSession instances should use global preemption
     </ul>
<li>public void setGlobalCredentialsProvider(CredentialsProvider cp)
     <ul>
     <li> Specifies that all HTTPSession instances should use the specified
          CredentialsProvider for authentication.
     </ul>
</ul>

<h4>Constructor(s)</h4>
<ul>
<li>public HTTPSession(String url)
     <ul>
     <li> Creates a session object with the specified
          session defining url.
     </ul>
</ul>

<h4>Instance Get/Set Methods</h4>
<ul>
<li>public void setAuthenticationPreemptive(boolean tf)
<li>public void setUserAgent(String agent)
<li>public void setConnectionManagerTimeout(long timeout)
<li>public void setSoTimeout(int timeout)
<li>public void setGlobalMethodParameter(String name, Object value)
    <ul>
    <li> Note that this a session instance 
    </ul>
<li>public String getCookiePolicy()
<li>public Cookie[] getCookies()
<li>public void setContext(HttpState cxt)
<li>public HttpState getContext()
<li>public void setProxy()
     <ul>
     <li> Set proxy authorization using the two system properties
		"http.proxyHost" and "http.proxyPort".
    </ul>
</ul>

<h4>Session Shutdown Methods</h4>
<ul>
<li>public synchronized void close()
     <ul>
     <li> Close this session and also any active HTTPMethods
          associated with this session.
     </ul>
</ul>

<h4>Session HTTPMethod Creation Methods</h4>
<ul>
<li>public HTTPMethod newMethod{Get|Head|Put|Post|Options}(String uri) throws HTTPException
</ul>

<h3><a name"HTTPMethod.API">HTTPMethod API</a></h3>
The API has a number of groups of methods.
<h4>Core</h4>
<ul>
<li> public int execute()
     <ul>
     <li> throws HTTPException
     </ul>
<li> public int getStatusCode()
<li> public String getStatusLine()
<li> public void setFollowRedirects(boolean tf)
<li> public static Enumeration getAllowedMethods()
</ul>

<h4>Responsebody</h4>
The API has a number of methods for getting the response
body in various forms. 
<ul>
<li> public InputStream getResponseBodyAsStream()
<li>(aka getResponseAsStream)
<li> public byte[] getResponseAsBytes(int maxsize)
<li> public byte[] getResponseAsBytes()
<li> public String getResponseAsString(String charset)
(aka getResponseAsString)
</ul>

<h4>Request Header Set/Get</h4>
<ul>
<li> public void setMethodHeaders(List<Header> headers) throws HTTPException
<li> public void setRequestHeader(String name, String value) throws HTTPException
<li> public void setRequestHeader(Header h) throws HTTPException
<li> public Header getRequestHeader(String name)
<li> public Header[] getRequestHeaders()
</ul>

<h4>Reponse Header Get</h4>
<ul>
<li> public Header getResponseHeader(String name)
<li> public Header[] getResponseHeaders()
<li> public Header[] getResponseFooters()
</ul>

<h4>Request Parameter Set/Get</h4>
<ul>
<li> public void setRequestParameter(String name, Object value)
<li> public Object getMethodParameter(String key)
<li> public HttpMethodParams getMethodParameters()
</ul>

<h4>Request Content Set</h4>
<ul>
<li> public void setRequestContentAsString(String content) throws HTTPException
<li> public void setMultipartRequest(Part[] parts) throws HTTPException
</ul>
</ul>

<h3><a name"HTTPMethodStream.API">HTTPMethodStream API</a></h3>
This class subclasses <i>java.io.InputStream</i>
and provides the <i>InputStream</i> interface.
In addition, if the stream is closed, then the
underlying method is closed as well.

<h2><u>Author</u></h2>
Author: Dennis Heimbigner<br>
Affiliation: UCAR/Unidata<br>
email: dmh@ucar.edu

</body>
</html>


