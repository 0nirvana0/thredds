<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>TDM</title>
<style type="text/css">
pre {font-size: 9pt; padding: 10px; background-color: #E7E7E7; border: 1px solid #CFCFCF; width: 85%;}
code {font-size: 11pt;}
dl {margin: 10px 5px 5px 15px;}
</style>
</head>

<body>
<h1><img src="../../../images/unidataLogo.png" alt="" width="73" height="75" align="absbottom" /> THREDDS Data Manager (TDM)</h1>
<hr />
<h2>Overview</h2>
<p>The TDM creates indexes for GRIB featureCollections,  independently of the TDS.</p>
<ol>
  <li>For static datasets, create indexes once, then start the TDS.</li>
  <li>For dynamic datasets, monitor changes, and create indexes in background, and send message to TDS when an index was recreated.</li>
</ol>
<p>Currently runs with 4 threads (change in /resources/application-config.xml)</p>
<h2>Running</h2>
<p>Create a shell script to run the TDM, for example  <strong>runTdm.sh</strong>:</p>
<pre>&lt;JAVA&gt; &lt;JVM options&gt; -catalog &lt;CATALOG&gt;


&quot;C:/Program Files/Java/jdk1.6.0_22/bin/java&quot; -Xmx8g -server -jar tdm-4.3.jar -catalog C:/dev/github/thredds/tds/content/thredds/enhancedCatalog.xml</pre>
<p>Notes:</p>
<ol>
  <li>Large collections need a lot of memory, so use a 64-bit JVM and give it 8 Gbytes memory (for example) if possible.</li>
  <li>&lt;catalog&gt; points to the catalog that contains GRIB featureCollections elements that you want to index in the background. It will follow catalog references, looking for these elements.</li>
  <li>For each featureCollection, a log file is create in the current working directory</li>
</ol>
<h2>Catalog Configuration</h2>
<h3>Static dataset:</h3>
<pre>&lt;featureCollection name=&quot;NOMADS-cfsrr-timeseries&quot; featureType=&quot;GRIB&quot; harvest=&quot;true&quot; path=&quot;grib/NOMADS/cfsrr/timeseries&quot;&gt;<br />  &lt;metadata inherited=&quot;true&quot;&gt;      
    &lt;dataType&gt;GRID&lt;/dataType&gt;
    &lt;dataFormat&gt;GRIB-2&lt;/dataFormat&gt;
  &lt;/metadata&gt;
  &lt;collection name=&quot;NOMADS-cfsrr-timeseries&quot; spec=&quot;/san4/work/jcaron/cfsrr/**/.*grb2$&quot;<br />                   dateFormatMark=&quot;#cfsrr/#yyyyMM&quot; timePartition=&quot;directory&quot;/&gt;<br />  <strong>&lt;tdm startup=&quot;true&quot;/&gt;</strong><br />&lt;/featureCollection&gt;</pre>
<ul>
  <li><strong>startup=&quot;true&quot;</strong> tells the TDM to index this dataset upon TDM startup. </li>
  <li>A log file will be written to <em>NOMADS-cfsrr-timeseries.log</em></li>
  <li>The TDS just uses the existing indexes, it does not monitor any changes in the dataset.</li>
</ul>
<h3>Dynamic dataset:</h3>
<pre>&lt;featureCollection name=&quot;DGEX-Alaska_12km&quot; featureType=&quot;GRIB&quot; harvest=&quot;true&quot; path=&quot;grib/NCEP/DGEX/Alaska_12km&quot;&gt;
  &lt;metadata inherited=&quot;true&quot;&gt;      
     &lt;dataType&gt;GRID&lt;/dataType&gt;
     &lt;dataFormat&gt;GRIB-2&lt;/dataFormat&gt;
  &lt;/metadata&gt;
  &lt;collection spec=&quot;/data/ldm/pub/native/grid/NCEP/DGEX/Alaska_12km/.*grib2$&quot;
   dateFormatMark=&quot;#DGEX_Alaska_12km_#yyyyMMdd_HHmm&quot;
   olderThan=&quot;5 min&quot;/&gt;
  <strong>&lt;tdm startup=&quot;true&quot; rescan=&quot;0 0/15 * * * ? *&quot; trigger=&quot;allow&quot;/&gt;</strong>
&lt;/featureCollection&gt;</pre>

<ul>
  <li><strong>startup=&quot;true&quot;</strong> tells the TDM to index this dataset upon TDM startup. </li>
  <li><strong>rescan=&quot;0 0/15 * * * ? *&quot; </strong>rescan directories every 15 minutes.</li>
  <li><strong>trigger=&quot;allow&quot;</strong> sends a message to TDS when the dataset index was recreated. When the TDS gets a trigger, it rereads the index for that dataset.</li>
  <li>To enable triggers, TDS needs this  in <strong>tomcat-users.xml:</strong>
    <pre>&lt;role rolename=&quot;tdsTrigger&quot; description=&quot;can trigger feature collections, eg from tdm&quot;/&gt;
&lt;user username=&quot;tdm&quot; password=&quot;...&quot; roles=&quot;tdsTrigger&quot;/&gt;<br /></pre>
  </li>
  <li>set username and password on tdm command line with <strong>-cred:username:password</strong>
    (username must match 
      tomcat-users.xml)
      <pre>/opt/jdk/bin/java -d64 -Xmx8g -server -jar tdm-4.3.jar -catalog path <strong>-cred tdm:password<strong>
</strong></strong></pre>
  </li>
</ul>
<hr width="100%" />
<h2>motherlode instructions</h2>
<h4>To restart the TDM:</h4>
<ol>
  <li>log in to motherlode</li>
  <li>cd ~caron</li>
  <li>sudo su ldm</li>
  <li>clean up logs
    <ol>
      <li>rm saveX/*</li>
      <li>mv *.log saveX</li>
      <li>mv tdm.log* save</li>
    </ol>
  </li>
  <li>sh ./runTdm.sh &amp;</li>
</ol>
<h4>TDM logs</h4>
<ol>
  <li>specific collections are in &lt;collectionName&gt;.log</li>
  <li>running tdm output is in tdm.log; these roll over every day</li>
</ol>
<h4>TDM source code</h4>
<ul>
  <li>in github under tdm module</li>
  <li>tdm-4.3 jar is built by maven</li>
  <li>configuration file is <strong>tdm\src\main\resources\resources\application-config.xml</strong>
    <ul>
      <li>currently set to trigger 8081 and 9080</li>
    </ul>
  </li>
</ul>
<p>&nbsp;</p>
<hr width="100%" />
<address>
<img src="../../../images/thread.png" alt="" width="76" height="67" /> This document is maintained by <a href="mailto:caron@unidata.ucar.edu">John Caron</a> and was last updated Jan 2013
</address>
</body>
</html>
