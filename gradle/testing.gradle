apply from: "$rootDir/gradle/dependencies.gradle"
apply plugin: "java"

dependencies {
    testCompile libraries["junit"]

    if (name != "cdm") {
        // Applying this to "cdm" creates a circular dependency.
        testCompile project(path: ':cdm', configuration: 'testArtifacts')
    }
}

tasks.withType(Test) {
//    outputs.upToDateWhen { false }  // Tests weren't being run when I changed included/excluded categories.

    useJUnit {
        excludeCategories 'ucar.unidata.test.util.NeedsCdmUnitTest'
    }

    if (!System.env['TRAVIS']) {
        ignoreFailures true
    }
}

// Add an SLF4J binding to testRuntime, if necessary.
afterEvaluate {
    if (testRuntimeHasDepNamed("slf4j-api")) {
        if (!testRuntimeHasDepNamed("slf4j-jdk14") && !testRuntimeHasDepNamed("log4j-slf4j-impl")) {
            dependencies.testRuntime libraries["slf4j-jdk14"]  // Default binding.
        }
    }
}

boolean testRuntimeHasDepNamed(String depName) {
    // Groovy truth: empty collections are coerced to false.
    configurations.testRuntime.allDependencies.findAll { it.name == depName }
}
